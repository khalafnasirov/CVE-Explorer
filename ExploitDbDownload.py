from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.common.by import By
import time, os, re
from event_manager import EventManager
import DataValues as dv
from Test_Chrome import CheckChrome

opts = Options()
event_manager = EventManager()

downloads_folder = os.path.join(os.path.expandvars("%USERPROFILE%"), "Downloads")

prefs = {
    'download.default_directory': downloads_folder,
    'download.prompt_for_download': False,
    'download.extensions_to_open': 'rb',
    'download.extensions_to_open': 'eml',
    'safebrowsing.enabled': True
}

opts.add_experimental_option('prefs', prefs)

def DownloadAnyExploit(download_url):
    driver = webdriver.Chrome()
    driver.get(download_url)
    time.sleep(5)

def RunExploitDbSelenium(search_query):

    if not CheckChrome():
        event_manager.trigger_event("chrome_not_installed_event")
        return

    dv.download_path = downloads_folder
    chrome_user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"
    opts.add_argument(f"user-agent={chrome_user_agent}")

    driver = webdriver.Chrome(options=opts)
    # agent = driver.execute_script("return navigator.userAgent")

    driver.get(f"https://www.exploit-db.com/search?cve={search_query}")

    wait = WebDriverWait(driver, 10)

    time.sleep(2)

    download_links = driver.find_elements(By.XPATH, '//table[@id="exploits-table"]/tbody//a[@href]')

    if download_links != []:
        counter = 0
        href_link = ""
        title_name = ""
        for link in download_links:
            if "download" in link.get_attribute("href"):
                href_link = str(link.get_attribute('href'))
                counter += 1
            if "exploits" in link.get_attribute("href"):
                title_name = link.accessible_name
                counter += 1
            if counter == 2:
                dv.exploit_db_links.append([title_name, href_link])
                href_link = ""
                title_name = ""
                counter = 0
    
    print(dv.exploit_db_links)

    if dv.exploit_db_links:
        dv.exploitdb_status = True
        event_manager.trigger_event("exploitdb_result_event", dv.exploitdb_status)
        print("Find Exploit event executed")
    else:
        dv.exploitdb_status = False
        event_manager.trigger_event("exploitdb_result_event", dv.exploitdb_status)
    
    dv.is_exploitdb_searched = True
