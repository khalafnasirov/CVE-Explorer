import DataValues as dv
from reportlab.lib.pagesizes import letter
from reportlab.platypus import SimpleDocTemplate, Paragraph
from reportlab.lib.styles import getSampleStyleSheet
from ReportGenerator import CheckDataSource
from event_manager import EventManager

event_manager = EventManager()

def AppendText(text, style, align_number):
    style.alignment = align_number
    p = Paragraph(text, style)


def ExportAsPdf():
    
    doc = SimpleDocTemplate(f"./PDFExports/cve-{dv.input_cve}-report.pdf")

    styles = getSampleStyleSheet()

    h_s_1 = styles['Heading1']
    h_s_2 = styles['Heading2']
    h_s_3 = styles['Heading3']
    b_s = styles['Normal']

    content = []

    def AppendText(text, style, align_number = 0, text_color = "black"):
        style.alignment = align_number
        style.textColor = text_color
        p = Paragraph(text, style)
        content.append(p)

    AppendText(f"Report about {CheckDataSource(dv.header)}", h_s_1, 1)

    AppendText("Name", h_s_2)
    AppendText(f"CVE-{CheckDataSource(dv.input_cve)}", b_s)
    AppendText("Base Score", h_s_2)
    AppendText(CheckDataSource(dv.base_score), b_s)
    AppendText("Vector", h_s_2)
    AppendText(CheckDataSource(dv.vector), b_s)
    AppendText("Description", h_s_2)
    AppendText(CheckDataSource(dv.description), b_s)
    if dv.hyperlinks != []:
        AppendText("Hyperlinks", h_s_2)
        for i, link in enumerate(dv.hyperlinks):
            AppendText(f"{link}", b_s, text_color="blue")
    if dv.cwe_names != []:
        AppendText("CVE IDs", h_s_2)
        for i, link in enumerate(dv.cwe_names):
            AppendText(f"{i+1}) {link}", b_s)
    AppendText("Nist", h_s_2)
    AppendText(CheckDataSource(dv.nist), b_s)
    AppendText("Source", h_s_2)
    AppendText(CheckDataSource(dv.source), b_s)
    AppendText("Exploit DB results", h_s_2)
    if dv.exploit_db_links != []:
        AppendText(dv.exploit_database_url, h_s_3, text_color="blue")
        for i, link in enumerate(dv.exploit_db_links):
            AppendText(f"{i+1}) {link[0]}", b_s)
    else:
        AppendText("No exploits found", b_s)
    AppendText("Extra info", h_s_2)
    AppendText(f"Publish time: {CheckDataSource(dv.publish_time)}", b_s)
    AppendText(f"Website link: {CheckDataSource(dv.running_url)}", b_s)
    AppendText(f"Exploit DB search link: {CheckDataSource(dv.exploit_database_url)}", b_s)

    doc.build(content)

    event_manager.trigger_event("pdf_exported_event")
    